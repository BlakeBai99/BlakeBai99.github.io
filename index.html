<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Wood Talk Furniture 报价单 — A4 Landscape Print</title>
<style>
  :root { --bg:#f7f7f8; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --accent:#1f2937; --accent-ink:#ffffff; --accent-weak:#334155; --ring:#94a3b8;}
  * { box-sizing: border-box; }
  html, body { height:100%; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", "Hiragino Sans GB", "Heiti SC", sans-serif; background:var(--bg); color: var(--ink); }
  .wrap { max-width: 1080px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 22px; margin: 0 0 8px; letter-spacing: .2px; font-weight:600; }
  .tiny { font-size: 12px; color: var(--muted); }
  .card { background: var(--card); border:1px solid var(--line); border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(15,23,42,.04); }
  .section-title { display:flex; align-items:center; gap:8px; font-weight:600; color:#111; }
  .section-title:before { content:""; width:6px; height:6px; background:#111; border-radius:999px; display:inline-block; }
  .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
  @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }
  .label { font-size: 13px; color: #374151; margin: 8px 0 6px; }
  input[type=number], input[type=text], input[type=date], input[type=tel], textarea { width: 100%; padding: 10px 12px; border-radius: 12px; border:1px solid var(--line); font-size: 14px; background:#fff; }
  textarea { min-height: 74px; resize: vertical; }
  .btns { display:flex; flex-wrap: wrap; gap:8px; margin-top: 12px; }
  button {
  border:0; border-radius: 12px; padding:10px 16px; font-size: 14px;
  cursor:pointer; transition: all .15s ease; line-height:1; 
  box-shadow: 0 1px 2px rgba(15, 23, 42, .05);
}
button:hover { transform: translateY(-1px); box-shadow: 0 6px 14px rgba(15, 23, 42, .08); }
button:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(15, 23, 42, .08); }
button:focus-visible { outline: none; box-shadow: 0 0 0 3px var(--ring); }
.primary { background: linear-gradient(180deg, var(--accent), var(--accent-weak)); color: var(--accent-ink); }
.primary:hover { filter: brightness(1.02); }
.primary:active { filter: brightness(.98); }
.ghost { background:#fff; border:1px solid var(--line); color: var(--accent); }
.ghost:hover { background:#f8fafc; }
.link-btn { background:transparent; border:0; padding:0 2px; color: var(--accent); text-decoration: underline; font-size:12px; }
  button:active { transform: translateY(1px); }
  .primary { background:var(--accent); color:#fff; }
  .ghost { background:#fff; border:1px solid var(--line); }
  footer { margin-top: 14px; color: var(--muted); font-size: 12px; }
  table { width:100%; border-collapse: collapse; }
  th, td { border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; font-size: 13px; vertical-align: middle; }
  .tbl-wrap { max-height: 420px; overflow:auto; border:1px solid var(--line); border-radius: 12px; }

  /* ===== 打印样式（A4 横向 / 欧洲极简）===== */
  @media print {
    /* Keep summary table pinned to the right column even if remarks are hidden */
    .quote-summary .summary-table {
      border:1px solid #d1d5db;
      border-radius:8px;
      overflow:hidden;
      width: 380px;
      font-size: 11pt;
      background:#fff;
    }

    /* --- images in print table --- */
    .quote-table img.pimg { max-width:100%; height:auto; aspect-ratio: 4/3; object-fit: cover; display:block; border: 1px solid #e5e7eb; border-radius: 4px; }
    .quote-table td.imgcol { vertical-align: top; }
    
    @page {
      size: A4 landscape;
      margin: 14mm 14mm 16mm 16mm; /* 顶、右、底、左 */
    }
    html, body { height:auto; }
    body {
      background:#fff;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      color:#111;
      font-weight: 400;
    }
    .no-print { display:none !important; }
    .wrap { display:none !important; } /* 网页操作区不打印 */
    .print-wrap { display:block !important; }
    /* 版式 */
    .quote {
      font-family: "SF Pro Text", ui-sans-serif, "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      font-size: 11.5pt; line-height: 1.5;
    }
    .quote-header {
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      align-items:flex-start;
      padding-bottom:8px;
      margin-bottom:10px;
      border-bottom:1px solid #cfcfcf;
    }
    .brand {
      font-size: 10pt; color:#4b5563;
    }
    .quote-title {
      font-size: 20pt; font-weight: 800; letter-spacing:.2px;
    }
    .meta {
      display:grid;
      grid-template-columns: repeat(2, max-content);
      column-gap:18px;
      row-gap:4px;
      white-space:pre-wrap;
      font-size: 10.5pt;
    }
    /* 表格 */
    .quote-table {
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed; /* 防止挤出页面 */
      border:1px solid #d9d9d9;
      border-radius:8px;
      overflow:hidden;
      font-variant-numeric: tabular-nums;
    }
    .quote-table thead th {
      background:#f2f4f7;
      border-bottom:1px solid #d1d5db;
      padding:6px 8px;
      font-weight:700;
      font-size: 11pt;
    }
    .quote-table td {
      padding:6px 8px;
      border-bottom:1px solid #efefef;
      font-size: 10.6pt;
      word-break: break-word;
    }
    .quote-table tr:last-child td { border-bottom:0; }
    .num { text-align:right; }
    .nowrap { white-space:nowrap; }
    .muted { color:#6b7280; }
    /* 避免分页断裂 */
    .avoid-break { break-inside: avoid; page-break-inside: avoid; }
    /* 汇总 */
    .quote-summary {
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr max-content;
      gap:10px;
    }
    .summary-table {
      border:1px solid #d1d5db;
      border-radius:8px;
      overflow:hidden;
      width: 380px;
      font-size: 11pt;
      background:#fff;
    }
    .summary-table th, .summary-table td {
      padding:6px 10px; border-bottom:1px solid #efefef;
    }
    .summary-table tr:last-child th, .summary-table tr:last-child td { border-bottom:0; }
    .summary-table th { text-align:left; background:#fafafa; width:62%; }
    .summary-table td { text-align:right; }
    .grand { font-weight:800; }
    /* 页脚页码 */
    .page-footer {
      position: fixed;
      bottom: 8mm;
      left: 16mm;
      right: 14mm;
      font-size: 9.5pt;
      color:#6b7280;
      display:flex;
      justify-content: space-between;
    }
    .page-footer .right::after {
      /* 简易页码（多数浏览器不支持 counter(page) 的话就显示空） */
      content: counter(page) " / " counter(pages);
    }
  }
</style>
</head>
<body>
<div class="wrap">
<h1>Wood Talk Furniture 报价单<span class="tiny"> — Address: 12–16 Camberwell Road, Hawthorn East, VIC 3123</span></h1>
<!-- 客户信息 -->
<div class="card">
<h2 class="section-title">客户信息 / Client</h2>
<div class="grid" style="grid-template-columns: 1fr; gap:12px;">
<div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
<div>
<div class="label">单号 / No.</div>
<input id="orderNo" placeholder="例如 WT-2025-001" type="text"/>
</div>
<div>
<div class="label">日期 / Date (YYYY-MM-DD)</div>
<input id="orderDate" pattern="\\d{4}-\\d{2}-\\d{2}" placeholder="2025-11-05" type="date"/>
</div>
</div>
<div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px;">
<div>
<div class="label">客户姓名 / Customer</div>
<input id="customerName" placeholder="如：Kirsten" type="text"/>
</div>
<div>
<div class="label">联系电话 / Phone</div>
<input id="customerPhone" placeholder="如：04xx xxx xxx" type="tel"/>
</div>
</div>
<div>
<div class="label">备注 / Notes</div>
<textarea id="remarks" placeholder="送货地址、送装说明、有效期、优惠说明等 / Delivery notes, validity, etc."></textarea>
</div>
<div class="label" style="display:flex;align-items:center;gap:8px;">
  <input type="checkbox" id="showRemarks">
  <span>打印时显示“备注 / Remarks”</span>
</div>
<div class="btns">
<button class="ghost" id="fillToday">日期填今天</button>
<button class="ghost" id="clearClient">清空客户信息</button>
<button class="primary" id="printQuote">预览/打印报价单</button>
</div>
</div>
</div>
<div class="grid" style="margin-top:12px;">
<div class="card">
<h2 class="section-title">汇率与运费 / Rates</h2>
<div class="label">汇率 (CNY / 1 AUD)</div>
<input id="cnyPerAud" min="0" placeholder="例如 4.90" step="0.01" type="number"/>
<div class="label">运费单价 (CNY/m³)</div>
<input id="ratePerM3CNY" min="0" placeholder="默认 1150" step="1" type="number"/>
</div>
<div class="card">
<h2 class="section-title">批量与导入导出 / Batch &amp; Import/Export</h2>
<div class="btns">
<button class="ghost" id="addRow">添加产品</button>
<button class="ghost" id="duplicateLast">复制最后一行</button>
<button class="ghost" id="reset">新建（清空全部）</button>
<button class="ghost" id="exportJSON">导出JSON</button>
<button class="ghost" id="exportCSV">导出CSV</button>
<input accept=".json,application/json" id="importJSON" style="display:none;" type="file"/>
<button class="ghost" id="importJSONBtn">导入JSON</button>
</div>
</div>
</div>
<div class="card" style="margin-top:12px;">
<h2 class="section-title">产品清单 / Items</h2>
<div class="tbl-wrap">
<table id="table">
<thead>
<tr>
<th style="min-width:120px;">图片</th>
<th style="min-width:200px;">产品型号 / 备注</th>
<th style="min-width:120px;">人民币单价 (CNY)</th>
<th style="min-width:80px;">数量</th>
<th style="min-width:140px;">单件体积 (m³)</th>
<th style="min-width:140px;">价格 (CNY)</th>
<th style="min-width:120px;">总体积 (m³)</th>
<th style="min-width:120px;">操作</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>
<div class="card" style="margin-top:12px;">
<div class="rows" id="rows"></div>
<div class="btns">
<button class="primary" id="copy">复制汇总</button>
</div>
</div>
<footer>打印时将自动切换为 A4 横向高端版式（中英双语）。</footer>
</div>
<!-- ===== 打印模板（仅打印时显示） ===== -->
<div class="print-wrap" style="display:none;">
<div class="quote">
<div class="quote-header">
<div>
<div class="quote-title">报价单 / Quotation</div>
<div class="brand">Wood Talk Furniture · 12–16 Camberwell Rd, Hawthorn East VIC 3123 · +61 (0)4xx xxx xxx</div>
</div>
<div class="meta">
<div><strong>单号 / No.</strong>：</div><div id="p_no">-</div>
<div><strong>日期 / Date</strong>：</div><div id="p_date">-</div>
<div><strong>客户 / Customer</strong>：</div><div id="p_customer">-</div>
<div><strong>电话 / Phone</strong>：</div><div id="p_phone">-</div>
<div><strong>汇率 / FX</strong>：</div><div id="p_fx">-</div>
<div><strong>运费单价 / Freight Rate</strong>：</div><div id="p_rate">-</div>
</div>
</div>
<table class="quote-table avoid-break" id="printTable"></table>
<div class="quote-summary avoid-break">
<div id="remarksBlock">
<div style="font-weight:600;margin-bottom:6px;">备注 / Remarks</div>
<div id="printRemarks" style="white-space:pre-wrap;"></div>
</div>
<table class="summary-table">
<tr><th>商品合计（AUD）/ Goods Total</th><td id="s_goods">A$0.00</td></tr>
<tr><th>总计体积 / Total Volume</th><td id="s_vol">0 m³</td></tr>
<tr><th>运费（AUD）/ Freight</th><td id="s_freight">A$0.00</td></tr>
<tr><th>服务费 5%（AUD）/ Service Fee</th><td id="s_fee">A$0.00</td></tr>
<tr><th>GST 10%（AUD）</th><td id="s_gst">A$0.00</td></tr>
<tr class="grand"><th>应付总额（AUD）/ Grand Total</th><td id="s_total">A$0.00</td></tr>
</table>
</div>
<div class="page-footer">
<div class="right">Page </div>
</div>
</div>
</div>
<script>

// --- helper: safe save to localStorage without huge image payloads ---
function __stripForStorage__(state){
  try {
    const cloned = JSON.parse(JSON.stringify(state));
    // remove base64 images from products to keep under 5MB quota
    if (cloned && Array.isArray(cloned.products)) {
      cloned.products = cloned.products.map(p => {
        if (!p) return p;
        const q = {...p};
        if (q.img && (typeof q.img === 'string') && q.img.startsWith('data:image/')) {
          // keep a tiny placeholder to indicate there was an image
          q.img = ''; // strip data URL
          q._hadImg = true;
        }
        return q;
      });
    }
    return cloned;
  } catch(e) {
    return state;
  }
}
function __safeSetItem__(key, value){
  try {
    localStorage.setItem(key, value);
  } catch (err) {
    try {
      const obj = JSON.parse(value);
      const slim = __stripForStorage__(obj);
      localStorage.setItem(key, JSON.stringify(slim));
      console.warn('Saved a slim version to localStorage (images removed) due to quota.');
    } catch(e2){
      console.warn('localStorage quota exceeded and fallback failed:', e2);
    }
  }
}

(function(){
  function setText(id, value){ const el = document.getElementById(id); if (el) el.textContent = value; }
  function getState(){ return state; }

  const $ = (id) => document.getElementById(id);
  const fmtAUD = (n) => new Intl.NumberFormat('en-AU', {style:'currency', currency:'AUD'}).format(n || 0);
  const fmtCNY = (n) => new Intl.NumberFormat('zh-CN', {style:'currency', currency:'CNY'}).format(n || 0);
  const fmtNum = (n, d=3) => new Intl.NumberFormat('en-US', {maximumFractionDigits:d}).format(n || 0);

  const LS_KEY = 'kelly_aud_calc_multi_v14';
  const defaults = {
    orderNo: '',
    orderDate: '',
    customerName: '',
    customerPhone: '',
    remarks: '',
    cnyPerAud: 4.9,
    ratePerM3CNY: 1150,
    products: [ { img:'', model:'', rmbPrice:0, qty:1, volPerItem:0 } ],
  };

  function load(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : structuredClone(defaults);
    } catch(e){ return structuredClone(defaults); }
  }
  function save(s){ __safeSetItem__(LS_KEY, JSON.stringify(s)); }

  let state = load();

  function toAUD(cny, cnyPerAud){ if (!cnyPerAud || cnyPerAud<=0) return 0; return (Number(cny)||0) / cnyPerAud; }

  function computeTotals(s){
    const cnyPerAud = Number(s.cnyPerAud) || 0;
    const ratePerM3CNY = Number(s.ratePerM3CNY) || 0;
    let productTotalCNY = 0, totalVolume = 0;
    s.products.forEach(p => {
      const lineCNY = (Number(p.rmbPrice)||0) * (Number(p.qty)||0);
      const lineVol = (Number(p.volPerItem)||0) * (Number(p.qty)||0);
      productTotalCNY += lineCNY;
      totalVolume += lineVol;
    });
    const freightCNY = ratePerM3CNY * totalVolume;
    const goodsAUD = toAUD(productTotalCNY, cnyPerAud);
    const freightAUD = toAUD(freightCNY, cnyPerAud);
    const serviceFeeAUD = (goodsAUD + freightAUD) * 0.05;
    const gstBaseAUD = goodsAUD + freightAUD + serviceFeeAUD;
    const gstAUD = gstBaseAUD * 0.10;
    const grandTotalAUD = goodsAUD + freightAUD + serviceFeeAUD + gstAUD;
    return { productTotalCNY, totalVolume, freightCNY, goodsAUD, freightAUD, serviceFeeAUD, gstAUD, grandTotalAUD };
  }

  function renderTable(){
    const tbody = $('tbody'); if (!tbody) return;
    tbody.innerHTML = '';
    state.products.forEach((p, idx) => {
      const lineCNY = (Number(p.rmbPrice)||0) * (Number(p.qty)||0);
      const lineVol = (Number(p.volPerItem)||0) * (Number(p.qty)||0);
      const hasImg = !!(p.img && typeof p.img === 'string');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="img-cell">
            <input type="file" accept="image/*" data-k="img" data-i="${idx}" style="display:none;">
            ${hasImg
              ? `<img class="thumb" data-img="${idx}" src="${p.img}" alt="thumb" style="width:44px;height:44px;border-radius:8px;object-fit:cover;border:1px solid #e5e7eb;">`
              : `<div class="thumb-empty" data-img="${idx}" style="display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px;background:#f9fafb;color:#9ca3af;border:1px dashed #e5e7eb;font-size:11px;cursor:pointer;">添加图片</div>`}
            <div class="img-hints no-print" style="display:flex;gap:6px;margin-left:8px;">
              <button class="link-btn" data-act="replace" data-i="${idx}">更换</button>
              <button class="link-btn" data-act="remove" data-i="${idx}">移除</button>
            </div>
          </div>
        </td>
        <td><input type="text" data-k="model" data-i="${idx}" value="${p.model??''}" placeholder="如：S03414 / 产品名 / 备注"></td>
        <td><input type="number" min="0" step="0.01" data-k="rmbPrice" data-i="${idx}" value="${p.rmbPrice??0}"></td>
        <td><input type="number" min="0" step="1" data-k="qty" data-i="${idx}" value="${p.qty??1}"></td>
        <td><input type="number" min="0" step="0.001" data-k="volPerItem" data-i="${idx}" value="${p.volPerItem??0}"></td>
        <td class="mono tiny" data-calc="lineCNY" data-i="${idx}">${fmtCNY(lineCNY)}</td>
        <td class="mono tiny" data-calc="lineVol" data-i="${idx}">${fmtNum(lineVol)}</td>
        <td class="row-actions no-print">
          <button data-act="dup" data-i="${idx}">复制</button>
          <button data-act="del" data-i="${idx}">删除</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function updateLineCells(i){
    const p = state.products[i] || {rmbPrice:0, qty:0, volPerItem:0};
    const lineCNY = (Number(p.rmbPrice)||0) * (Number(p.qty)||0);
    const lineVol = (Number(p.volPerItem)||0) * (Number(p.qty)||0);
    const c1 = document.querySelector(`td[data-calc="lineCNY"][data-i="${i}"]`);
    const c2 = document.querySelector(`td[data-calc="lineVol"][data-i="${i}"]`);
    if (c1) c1.textContent = fmtCNY(lineCNY);
    if (c2) c2.textContent = fmtNum(lineVol);
  }

  function renderSummary(){
    const rowsBox = $('rows'); if (!rowsBox) return;
    const t = computeTotals(state);
    const goodsCNY = state.products.reduce((n,p)=>n+(Number(p.rmbPrice)||0)*(Number(p.qty)||0),0);
    const lines = [
      ['商品合计 / Goods (AUD)', fmtAUD(t.goodsAUD) + '  (≈ ' + fmtCNY(goodsCNY) + ')'],
      ['总计体积 / Total Volume', fmtNum(t.totalVolume) + ' m³'],
      ['运费 / Freight (AUD)', fmtAUD(t.freightAUD) + '  (≈ ' + fmtCNY(t.freightCNY) + ')'],
      ['服务费 5% / Service Fee', fmtAUD(t.serviceFeeAUD) ],
      ['GST 10%', fmtAUD(t.gstAUD) ],
      ['应付总额 / Grand Total', fmtAUD(t.grandTotalAUD), true],
    ];
    rowsBox.innerHTML = lines.map(([k,v,em]) => `
      <div class="row ${em?'em':''}" style="display:flex;justify-content:space-between;background:${em?'#111':'#f3f4f6'};color:${em?'#fff':'#111'};border-radius:12px;padding:10px 12px;margin-top:8px;">
        <div style="font-size:13px;${em?'color:#d1d5db;':''}">${k}</div>
        <div style="font-size:14px;font-variant-numeric: tabular-nums;">${v}</div>
      </div>
    `).join('');
  }

  function bindTableEvents(){
    const tbody = $('tbody'); if (!tbody) return;
    tbody.addEventListener('input', (e) => {
      const t = e.target;
      const i = Number(t.getAttribute('data-i'));
      const k = t.getAttribute('data-k');
      if (k === 'model') {
        state.products[i].model = String(t.value).slice(0, 200);
      } else {
        const raw = t.value; const num = Number(raw);
        state.products[i][k] = (raw === '' || raw === '-' || raw === '.' || raw === '-.') ? state.products[i][k] : (isNaN(num) ? 0 : num);
      }
      save(state); updateLineCells(i); renderSummary();
    });

    tbody.addEventListener('click', (e) => {
      const imgTrigger = e.target.closest('[data-img]');
      if (imgTrigger) {
        const i = Number(imgTrigger.getAttribute('data-img'));
        const input = document.querySelector(`input[type="file"][data-k="img"][data-i="${i}"]`);
        if (input) input.click();
        return;
      }
      const b = e.target.closest('button'); if (!b) return;
      const i = Number(b.getAttribute('data-i'));
      const act = b.getAttribute('data-act');
      if (act === 'dup') {
        const src = state.products[i];
        state.products.splice(i+1, 0, {...src});
        save(state); renderTable(); renderSummary();
      } else if (act === 'del') {
        if (state.products.length <= 1) {
          state.products[0] = { img:'', model:'', rmbPrice:0, qty:1, volPerItem:0 };
        } else {
          state.products.splice(i,1);
        }
        save(state); renderTable(); renderSummary();
      } else if (act === 'replace') {
        const input = document.querySelector(`input[type="file"][data-k="img"][data-i="${i}"]`);
        if (input) input.click();
      } else if (act === 'remove') {
        state.products[i].img = '';
        save(state); renderTable();
      }
    });

    tbody.addEventListener('change', (e) => {
      const t = e.target;
      if (t.type === 'file' && t.dataset.k === 'img') {
        const i = Number(t.getAttribute('data-i'));
        const file = t.files && t.files[0];
        if (file) {
          if (file.size > 2 * 1024 * 1024) {
            if (!confirm('图片大于 2MB，继续可能导致浏览器存储不足，是否继续？')) { t.value=''; return; }
          }
          const reader = new FileReader();
          reader.onload = (ev) => {
            state.products[i].img = String(ev.target.result || '');
            save(state); renderTable();
          };
          reader.readAsDataURL(file);
        }
        t.value = '';
      }
    });
  }

  function bindClientControls(){
    // 赋初值
    $('orderNo').value = state.orderNo || '';
    $('orderDate').value = state.orderDate || '';
    $('customerName').value = state.customerName || '';
    $('customerPhone').value = state.customerPhone || '';
    $('remarks').value = state.remarks || '';
    if ($('showRemarks')) $('showRemarks').checked = !!state.showRemarks;
    $('cnyPerAud').value = state.cnyPerAud ?? 4.9;
    $('ratePerM3CNY').value = state.ratePerM3CNY ?? 1150;

    const sync = (id, key) => {
      $(id).addEventListener('input', (e)=>{
        state[key] = e.target.value || ''; save(state);
      });
    };
    sync('orderNo','orderNo');
    sync('orderDate','orderDate');
    sync('customerName','customerName');
    sync('customerPhone','customerPhone');
    sync('remarks','remarks');
    if ($('showRemarks')) {
      $('showRemarks').addEventListener('change', (e)=>{ state.showRemarks = !!e.target.checked; save(state); });
    }

    $('fillToday').addEventListener('click', ()=>{
      const d = new Date();
      const iso = d.toISOString().slice(0,10); // YYYY-MM-DD
      $('orderDate').value = iso; state.orderDate = iso; save(state);
    });

    $('clearClient').addEventListener('click', ()=>{
      if (!confirm('清空客户信息？')) return;
      state.orderNo=''; state.orderDate=''; state.customerName=''; state.customerPhone=''; state.remarks='';
      save(state); bindClientControls();
    });

    $('importJSONBtn').addEventListener('click', () => { $('importJSON').click(); });

    $('printQuote').addEventListener('click', ()=>{
      // 将数据同步到打印模板
      const t = computeTotals(state);
      const goodsCNY = state.products.reduce((n,p)=>n+(Number(p.rmbPrice)||0)*(Number(p.qty)||0),0);

      $('p_no').textContent = state.orderNo || '-';
      $('p_date').textContent = state.orderDate || '-';
      $('p_customer').textContent = state.customerName || '-';
      $('p_phone').textContent = state.customerPhone || '-';
      $('p_fx').textContent = `1 AUD = ${state.cnyPerAud || 0} CNY`;
      $('p_rate').textContent = `¥${state.ratePerM3CNY || 0} / m³`;

      // 构建打印表格
      const tbl = $('printTable');
      tbl.innerHTML = '';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
        <th style="width:18%;">图片</th>
        <th style="width:32px;">#</th>
        <th style="width:27%;">产品型号与配置 / Model & Notes</th>
        <th style="width:11%;" class="num">单价 (CNY)</th>
        <th style="width:8%;" class="num">数量</th>
        <th style="width:12%;" class="num">单件体积 (m³)</th>
        <th style="width:14%;" class="num">价格 (CNY)</th>
        <th style="width:10%;" class="num">总体积 (m³)</th>
      </tr>`;
      tbl.appendChild(thead);
      const tbody = document.createElement('tbody');
      state.products.forEach((p,i)=>{
        const lineCNY = (Number(p.rmbPrice)||0)*(Number(p.qty)||0);
        const lineVol = (Number(p.volPerItem)||0)*(Number(p.qty)||0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="imgcol">${(p.img ? `<img class="pimg" src="${p.img}" alt="">` : ``)}</td><td>${i+1}</td>
          <td>${(p.model||'未命名 / Untitled').replace(/[\n\r]/g, ' ')}</td>
          <td class="num">${(Number(p.rmbPrice)||0).toFixed(2)}</td>
          <td class="num">${Number(p.qty)||0}</td>
          <td class="num">${(Number(p.volPerItem)||0).toFixed(3)}</td>
          <td class="num">${lineCNY.toFixed(2)}</td>
          <td class="num">${lineVol.toFixed(3)}</td>`;
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);

      // 汇总（AUD + 参考CNY）
      $('s_goods').textContent   = fmtAUD(t.goodsAUD);
      $('s_vol').textContent     = fmtNum(t.totalVolume) + ' m³';
      $('s_freight').textContent = fmtAUD(t.freightAUD);
      $('s_fee').textContent     = fmtAUD(t.serviceFeeAUD);
      $('s_gst').textContent     = fmtAUD(t.gstAUD);
      $('s_total').textContent   = fmtAUD(t.grandTotalAUD);
      (() => { const el = document.getElementById('s_total_cny'); if (el) el.textContent = fmtCNY((t.grandTotalAUD || 0) * (state.cnyPerAud || 0)); })();

      $('printRemarks').textContent = state.remarks || '';
      (function(){ const rb = $('remarksBlock'); if (rb) rb.style.display = state.showRemarks ? '' : 'none'; })();

      window.print();
    });
  }

  function bindControls(){
    $('cnyPerAud').addEventListener('input', (e)=>{
      const raw = e.target.value; const num = Number(raw);
      state.cnyPerAud = (raw === '' || raw === '.' || raw === '-.' || raw === '-') ? state.cnyPerAud : (isNaN(num) ? state.cnyPerAud : num);
      save(state); renderSummary();
    });
    $('ratePerM3CNY').addEventListener('input', (e)=>{
      const raw = e.target.value; const num = Number(raw);
      state.ratePerM3CNY = (raw === '' || raw === '.' || raw === '-.' || raw === '-') ? state.ratePerM3CNY : (isNaN(num) ? state.ratePerM3CNY : num);
      save(state); renderSummary();
    });

    $('addRow').addEventListener('click', ()=>{
      state.products.push({ img:'', model:'', rmbPrice:0, qty:1, volPerItem:0 });
      save(state); renderTable(); renderSummary();
    });
    $('duplicateLast').addEventListener('click', ()=>{
      const last = state.products[state.products.length-1];
      state.products.push({...last});
      save(state); renderTable(); renderSummary();
    });
    $('reset').addEventListener('click', ()=>{
      if (!confirm('清空全部数据并新建？')) return;
      state = structuredClone(defaults);
      save(state); bindClientControls(); renderTable(); renderSummary();
    });
    $('exportJSON').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'aud_calc_v14.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('exportCSV').addEventListener('click', ()=>{
      const meta = [
        `# 单号,${state.orderNo||''}`,
        `# 日期,${state.orderDate||''}`,
        `# 客户姓名,${state.customerName||''}`,
        `# 电话,${state.customerPhone||''}`,
        `# 备注,${(state.remarks||'').replace(/\\n/g,' ')}`,
        `# 汇率,${state.cnyPerAud||0}`,
        `# 运费单价(CNY/m3),${state.ratePerM3CNY||0}`,
      ].join('\\n');
      const headers = ['img','model','rmbPrice','qty','volPerItem'];
      const lines = [meta, headers.join(',')].concat(
        state.products.map(p => headers.map(h => {
          let v = (p[h] ?? '');
          if (h === 'img') v = v ? '[embedded]' : '';
          return String(v).replace(/"/g,'""');
        }).map(x => `"${x}"`).join(','))
      );
      const blob = new Blob([lines.join('\\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'aud_calc_v14.csv'; a.click(); URL.revokeObjectURL(url);
    });

    $('copy').addEventListener('click', async () => {
      const t = computeTotals(state);
      const goodsCNY = state.products.reduce((n,p)=>n+(Number(p.rmbPrice)||0)*(Number(p.qty)||0),0);
      const lines = [];
      lines.push(`单号: ${state.orderNo||'-'}  日期: ${state.orderDate||'-'}`);
      lines.push(`客户: ${state.customerName||'-'}  电话: ${state.customerPhone||'-'}`);
      if (state.remarks) lines.push(`备注: ${state.remarks.replace(/\\n/g,' ')}`);
      lines.push('——— 汇总 ———');
      lines.push(`商品合计(AUD): ${fmtAUD(t.goodsAUD)} (≈${fmtCNY(goodsCNY)})`);
      lines.push(`总计体积: ${fmtNum(t.totalVolume)} m³`);
      lines.push(`运费(AUD): ${fmtAUD(t.freightAUD)} (≈${fmtCNY(t.freightCNY)})`);
      lines.push(`服务费 5%: ${fmtAUD(t.serviceFeeAUD)}`);
      lines.push(`GST 10%: ${fmtAUD(t.gstAUD)}`);
      lines.push(`应付总额(AUD): ${fmtAUD(t.grandTotalAUD)}`);
      lines.push('——— 明细 ———');
      state.products.forEach((p,i)=>{
        const lineCNY = (Number(p.rmbPrice)||0)*(Number(p.qty)||0);
        const lineVol = (Number(p.volPerItem)||0)*(Number(p.qty)||0);
        lines.push(`${i+1}. ${p.model||'未命名'} | 单价¥${p.rmbPrice||0} ×${p.qty||0} | 行计¥${lineCNY.toFixed(2)} | 行体积 ${lineVol}`);
      });
      try{ await navigator.clipboard.writeText(lines.join('\\n')); alert('汇总已复制到剪贴板'); }
      catch(e){ alert('复制失败，请手动选择文本复制'); }
    });
  }

  // init
  function init(){
    bindClientControls();
    bindControls();
    renderTable();
    renderSummary();
    bindTableEvents();

    // Import JSON handler
    const importInput = $('importJSON');
    if (importInput) {
      importInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const obj = JSON.parse(String(ev.target.result || '{}'));
            // Basic validation and merge with defaults to avoid missing keys
            state = Object.assign(structuredClone(defaults), obj || {});
            // Ensure products array exists
            if (!Array.isArray(state.products) || state.products.length === 0) {
              state.products = [ { img:'', model:'', rmbPrice:0, qty:1, volPerItem:0 } ];
            }
            save(state);
            // Re-bind and re-render all
            bindClientControls();
            renderTable();
            renderSummary();
            bindTableEvents();
            alert('JSON 已导入并应用。');
          } catch (e) {
            alert('导入失败：文件格式不正确。');
            console.error(e);
          } finally {
            importInput.value = '';
          }
        };
        reader.readAsText(file, 'utf-8');
      });
    }

  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
// Request persistent storage (best-effort)
if (navigator.storage && navigator.storage.persist) {
  navigator.storage.persist().then(granted => {
    console.log('Persistent storage', granted ? 'granted' : 'not granted');
  });
}

// 导出(含图片)：保存为本地文件，避免 localStorage 大小限制
function __exportWithImages__(filename='quote_with_images.kelly'){
  try{
    // 假设全局 getState() 存在，否则回退到从 DOM 组装
    const state = (typeof getState === 'function') ? getState() : window.__state || {};
    const json = JSON.stringify(state, null, 2);
    const blob = new Blob([json], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }catch(e){
    console.error('导出失败', e);
    alert('导出失败：' + e.message);
  }
}

document.addEventListener('click', (e) => {
  if(e.target && e.target.id === 'exportWithImages'){
    const today = new Date().toISOString().slice(0,10);
    __exportWithImages__(`quotation_${today}.kelly.json`);
  }
});
</script>
</body>
</html>
